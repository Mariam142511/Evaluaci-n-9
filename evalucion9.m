%% Evaluaci√≥n 9
%Mariam Landa Bautista A01736672



 


%% Define Vehicle
R = 0.1;                % Wheel radius [m]
L = 0.5;                % Wheelbase [m]
dd = DifferentialDrive(R,L);

%% Simulation parameters
sampleTime = 0.05;               % Sample time [s]
tVec = 0:sampleTime:1000;         % Time array

%CAMBIAR CONFORME A LAS ESPECIFICACIONES DE CADA TRAYECTORIA O DIBUJO
initPose = [2.9028608777496;0.1897059908332;0];             % Initial pose (x y theta)
pose = zeros(3,numel(tVec));    % Pose matrix
pose(:,1) = initPose;

% Define waypoints
% ----- Ejercicio Trayectoria: Rostro -------------
waypoints = [-48.1210543139975, -17.233504746009;
    -3.5400120394634, -17.233504746009;
    -29.6840665776298, 25.1808786576046;
    -27.8217445840573, 25.0644835330063;
    -25.2610518428951, 24.2497176608183;
    -23.165939600126, 22.3873956672458;
    -22.5839639771346, 20.5250736736733;
    -21.1872224819553, 17.498800434118;
    -19.7904809867759, 13.5413661977765;
    -20, 10;
    -18.6265297407931, 7.3724245940676;
    -18.8593199899897, 4.6953367283071;
    -20.7216419835621, 3.2985952331278;
    -22.8167542263312, 1.2034829903587;
    -24.9118664691003, 0.2723219935725;
    -27.1233738364676, -0.6588390032138;
    -30, 0;
    -31.0808080728091, 2.2510391117432;
    -32.9431300663816, 4.229756229914;
    -34.1070813123644, 6.6740538464779;
    -35.7366130567404, 9.7003270860332;
    -36.3185886797318, 12.6102052009902;
    -36.4349838043301, 17.498800434118;
    -36.0418502766427, 19.0055435881547;
    -35.8486396207746, 20.4224217311875;
    -35.5480897116465, 21.6890249196562;
    -35.0328612959982, 23.170306614645;
    -34.2814865231778, 24.3939741018096;
    -32.7358012762329, 25.2956238291941;
    -31.2366809163372, 25.5842490107008;
    -30, 27;
    -29.8639996187646, 28.2119532089112;
    -29.334536832558, 29.172830117212;
    -28.5305377868369, 30.0356583614005;
    -27.2755148861991, 30.4278530178499;
    -26.1577601153185, 30.5455114147847;
    -24.4713230925865, 30.4082432850274;
    -23.1182515278363, 30.1925362239803;
    -21.7847896959086, 29.6434637049512;
    -19.9775732407332, 28.6999530075565;
    -18.3826080971265, 27.6487259810885;
    -17.25888265504, 26.3437544999558;
    -16.3164032519997, 25.0025338110138;
    -15.7001667192426, 23.5888147064533;
    -14.9026841474392, 22.4288400565575;
    -14.4314444459191, 21.0151209519971;
    -13.9964539522082, 19.2026605615349;
    -13.380217419451, 17.3902001710728;
    -12.9452269257401, 15.5052413649921;
    -12.5503565629993, 14.2806856207329;
    -11.6755944819797, 13.0310255049906;
    -10.6758663893859, 11.1981906685686;
    -10.4675897034288, 9.2403898205724;
    -10.8392108869549, 7.4933279876345;
    -10.6808337420577, 5.7907736799989;
    -10.4432680247118, 4.6029450932597;
    -10.2057023073659, 3.1775507891844;
    -9.6117880140012, 2.1876936335765;
    -8.5427422859448, 0.8414879019499;
    -8.1863937099259, -0.7422835470226;
    -8.819902289515, -3.1575350067057;
    -6.3254622573832, -4.6621178832296;
    -4.5833136635135, -5.7311636112861;
    -5.8107365364672, -7.3149350602586;
    -8.1072051374773, -7.1169636291371;
    -9.5325994415526, -6.9585864842398;
    -10.9269561179849, -8.0801612692522;
    -12.6845210354681, -9.2785009857181;
    -14.4420859529513, -11.9947376763739;
    -17.3181012724692, -10.0773941300286;
    -18.0371051023486, -6.7220429239243;
    -16.7588760714518, -4.5650314342859;
    -17.5577692157623, -2.5677985735095;
    -18.6762196177971, -0.5705657127332;
    -19.155555043834, 2.2255602923537;
    -31.2188419834724, -0.171191405779;
    -31.8579564989208, -2.6476878879406;
    -30.4199488391619, -4.2454741765617;
    -30.8193954113171, -6.4823749806312;
    -31.6981778700587, -9.2785009857181;
    -32.4970710143693, -11.2757338464944;
    -33.615521416404, -12.6338521918223;
    -36.8909833080772, -12.9534094495465;
    -38.5686589111293, -10.4768407021839;
    -39.9267772564572, -8.7991650991317;
    -41.7642314883714, -6.6421536094933;
    -41.2050062873541, -3.6063596611132;
    -40, 0;
    -37.7697657668188, 2.5451175500779;
    -39.2876627410088, 5.5809114984579;
    -40.006665708883, 8.696594761269;
    -38.5686589111293, 11.9321119957267;
    -38.3289909678361, 14.5684593719515;
    -38.5100463095905, 16.0118684963214;
    -38.4324511631244, 18.4431830855941;
    -38.225530772548, 21.1072831142653;
    -37.8634200890393, 23.021296727097;
    -37.0202148403505, 24.7312603266313;
    -36.3052304984886, 26.2208110388435;
    -34.7858887720322, 27.7699437795442;
    -33.3261290740643, 28.5147191356503;
    -31.9855334330733, 29.0211663778024;
    -30.3768186638842, 29.2892855060006;
    -29.1243122485555, 6.6789530466172;
    -28.3491361031344, 6.3245868087104;
    -27.66255151719, 6.1252557998878;
    -26.6880443629463, 5.9259247910652;
    -25.6027977593568, 5.8816290113269;
    -25.6913893188335, 5.0843049760366;
    -26.643748583208, 4.1983893812696;
    -27.5961078475825, 3.4453611257177;
    -28.7035023410412, 3.1795864472876;
    -29.567270045939, 3.0688469979417;
    -30.5639250900519, 3.6003963548019;
    -30.962587107697, 4.3312767204846;
    -31.3169533456038, 4.9736555266907;
    -31.4276927949497, 5.3722275443359;
    -30.9182913279587, 6.1695515796262;
    -30.4088898609677, 6.4574741479254;
    -29.9659320635842, 6.2581431391029;
    -27.7476367757575, 8.6152174393521;
    -27.5318950769267, 9.6631056908158;
    -28.1482999307289, 10.6185332142092;
    -28.9496262406717, 11.4815000095322;
    -29.3811096383332, 12.3752870475454;
    -29.6584918225442, 13.3307145709387;
    -29.8434132786848, 14.5943445212332;
    -29.7509525506145, 15.5189518019364;
    -28.9188059979816, 16.5051995680199;
    -28.0558392026585, 16.9366829656814;
    -27.2545128927157, 17.2757056352726;
    -26.2374448839422, 17.5530878194836;
    -25.3128376032389, 17.8921104890748;
    -24.3265898371555, 18.0770319452154;
    -23.5560837699028, 17.9845712171451;
    -22.7239372172698, 17.7996497610045;
    -23.643240002305, 18.7069400053377;
    -24.7300451831595, 19.1021418892848;
    -25.8415504817608, 18.8057404763244;
    -27.0024560158554, 18.4105385923773;
    -28, 18;
    -28.9043650823508, 17.3237334115228;
    -29.6206684970049, 16.8544311743356;
    -32.8563839218217, 16.4839294081352;
    -33.8443886316895, 16.6074299968687;
    -34.7582929883171, 16.6568302323621;
    -35.6474972271981, 16.903831409829;
    -36.0426991111452, 17.0520321163092;
    -36.3638006418522, 16.014627170948;
    -35.6968974626915, 16.2863284661617;
    -35.0052941657841, 16.1381277596815;
    -34, 16;
    -33.4738868654891, 15.8417263467212;
    -32.757583450835, 15.5700250515075;
    -32.2635810959011, 15.125422932067;
    -31.917794474474, 14.5820203416398;
    -31.6954783877271, 14.1127181044526;
    -31.547277681247, 13.1247133945848;
    -31.5966779167404, 11.81560715401;
    -31.5966779167404, 10.7041018554088;
    -31.7201785054738, 9.2220947906072;
    -31.965043062567, 8.5540704615444;
    -31.5985944529389, 8.309771388459;
    -31.2592901847647, 8.1604775104623;
    -30.7435476971399, 7.9840392910118;
    -30.1192278436993, 8.1740496811893;
    -29.6034853560745, 8.3369157299129;
    -28.9384489904531, 8.5133539493635;
    -28.4227065028283, 8.4997817786366;
    -27.6083762592102, 14.4986812399567;
    -27.241927649582, 14.8922741910387;
    -26.821190357046, 15.2044341177759;
    -26.2647313572403, 15.4894497030254;
    -25.4504011136222, 15.7066044346569;
    -24.676787382185, 15.6930322639299;
    -23.8081684556591, 15.5980270688411;
    -23.2788537973073, 15.5437383859332;
    -23.0752712364028, 15.2451506299399;
    -23.7674519434782, 14.8922741910387;
    -24.0388953580175, 14.4986812399567;
    -24.8396534309087, 14.2000934839633;
    -25.4504011136222, 14.0507996059667;
    -26, 14;
    -26.6990408205033, 14.1050882888746;
    -27.255499820309, 14.1729491425094;
    -35.2902248906742, 14.0507996059667;
    -34.8830597688652, 14.3086708497791;
    -34.2451677446977, 14.5393977521376;
    -33.675136574165, 14.5665420935915;
    -33.1729662572672, 14.5122534106836;
    -32.6843681110963, 14.362959532687;
    -32.2772029892873, 14.1322326303285;
    -32.1279091112906, 13.6572066548846;
    -32.7793733061851, 13.480768435434;
    -33.4715540132605, 13.1686085087137;
    -34, 13;
    -34.6251885250528, 13.0193146307171;
    -35.0052093054079, 13.3450467281643;
    -35.1680753541315, 13.6300623134307;]
 
% Create visualizer
viz = Visualizer2D;
viz.hasWaypoints = true;

%% Pure Pursuit Controller
controller = controllerPurePursuit;
controller.Waypoints = waypoints;
%muy largo no sabremos a que way point va a ir
controller.LookaheadDistance = 0.15; %muy corto no vera el waypoint
controller.DesiredLinearVelocity = 0.15;
controller.MaxAngularVelocity = 800;

%% Simulation loop
close all
r = rateControl(1/sampleTime);
for idx = 2:numel(tVec) 
    % Run the Pure Pursuit controller and convert output to wheel speeds
    [vRef,wRef] = controller(pose(:,idx-1));
    [wL,wR] = inverseKinematics(dd,vRef,wRef)
 
    
    % Compute the velocities
    [v,w] = forwardKinematics(dd,wL,wR);
    velB = [v;0;w]; % Body velocities [vx;vy;w]
    vel = bodyToWorld(velB,pose(:,idx-1));  % Convert from body to world
    
    % Perform forward discrete integration step
    pose(:,idx) = pose(:,idx-1) + vel*sampleTime; 
    
    % Update visualization
    viz(pose(:,idx),waypoints)
    waitfor(r);
    
end